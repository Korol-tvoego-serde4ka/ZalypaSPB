let currentUser=null;let sessionData={users:[{id:1,username:"testuser",role:"User",email:"user@zalypa.com",status:"Активен"},{id:2,username:"testreseller",role:"Reseller",email:"reseller@zalypa.com",status:"Активен"},{id:3,username:"testadmin",role:"Admin",email:"admin@zalypa.com",status:"Активен"},{id:4,username:"john_doe",role:"User",email:"john@example.com",status:"Активен"},{id:5,username:"jane_smith",role:"User",email:"jane@example.com",status:"Неактивен"}],products:[{id:1,name:"Premium Key",type:"Premium",price:5000},{id:2,name:"Basic Key",type:"Basic",price:2000},{id:3,name:"Enterprise Key",type:"Enterprise",price:15000}],resellerUsers:[{id:101,username:"client_1",email:"client1@example.com",status:"Активен"},{id:102,username:"client_2",email:"client2@example.com",status:"Активен"},{id:103,username:"client_3",email:"client3@example.com",status:"Неактивен"}],resellerProducts:[{id:201,name:"Starter Pack",type:"Basic",price:1500},{id:202,name:"Pro Pack",type:"Premium",price:4000}],logs:[{who:"testadmin",what:"Добавил нового пользователя john_doe",when:"2025-11-01 09:30"},{who:"testreseller",what:"Создал продукт Premium Key",when:"2025-11-01 10:15"},{who:"testadmin",what:"Изменил настройки системы",when:"2025-11-01 11:00"},{who:"testreseller",what:"Удалил пользователя old_client",when:"2025-11-01 12:45"},{who:"testadmin",what:"Обновил профиль пользователя jane_smith",when:"2025-11-01 14:20"}]};
function hashPassword(p){return"bcrypt_"+btoa(p)}
function sanitizeInput(i){const d=document.createElement("div");d.textContent=i;return d.innerHTML}
function showNotification(message,type="success"){const n=document.createElement("div");n.className=`notification ${type}`;n.textContent=message;document.body.appendChild(n);setTimeout(()=>{n.remove()},3000)}
document.getElementById("loginForm").addEventListener("submit",e=>{e.preventDefault();const u=sanitizeInput(document.getElementById("username").value.trim());const p=document.getElementById("password").value;const valid={testuser:{password:"demo",role:"User"},testreseller:{password:"demo",role:"Reseller"},testadmin:{password:"demo",role:"Admin"}};if(valid[u]&&valid[u].password===p){currentUser={username:u,role:valid[u].role,passwordHash:hashPassword(p)};sessionData.logs.unshift({who:u,what:"Вход в систему",when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});document.getElementById("loginPage").style.display="none";showDashboard(valid[u].role);showNotification("Успешный вход в систему!","success")}else{const err=document.getElementById("loginError");err.textContent="Неверное имя пользователя или пароль";err.classList.remove("hidden")}});
function showDashboard(role){document.getElementById("userDashboard").classList.remove("active");document.getElementById("resellerDashboard").classList.remove("active");document.getElementById("adminDashboard").classList.remove("active");if(role==="User"){document.getElementById("userDashboard").classList.add("active");document.getElementById("userUsername").textContent=currentUser.username;loadUserProducts()}else if(role==="Reseller"){document.getElementById("resellerDashboard").classList.add("active");document.getElementById("resellerUsername").textContent=currentUser.username;loadResellerData()}else if(role==="Admin"){document.getElementById("adminDashboard").classList.add("active");document.getElementById("adminUsername").textContent=currentUser.username;loadAdminData()}}
function showSection(btn,sectionId){const dash=document.querySelector(".dashboard.active");if(dash){dash.querySelectorAll(".content-section").forEach(s=>s.classList.remove("active"));dash.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"))}document.getElementById(sectionId).classList.add("active");if(btn)btn.classList.add("active")}
function logout(){if(currentUser){sessionData.logs.unshift({who:currentUser.username,what:"Выход из системы",when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})})}currentUser=null;document.getElementById("userDashboard").classList.remove("active");document.getElementById("resellerDashboard").classList.remove("active");document.getElementById("adminDashboard").classList.remove("active");document.getElementById("loginPage").style.display="flex";document.getElementById("loginForm").reset();document.getElementById("loginError").classList.add("hidden");showNotification("Вы вышли из системы","info")}
function openModal(id){document.getElementById(id).classList.add("active")}
function closeModal(id){document.getElementById(id).classList.remove("active")}
function loadUserProducts(){const c=document.getElementById("userProductsList");c.innerHTML="";sessionData.products.forEach(p=>{const card=document.createElement("div");card.className="product-card";card.innerHTML=`<div class="product-name">${sanitizeInput(p.name)}</div><div class="product-info">Тип: ${sanitizeInput(p.type)}</div><div class="product-info">Цена: ₽${p.price}</div>`;c.appendChild(card)})}
function loadResellerData(){loadResellerUsers();loadResellerProducts();updateResellerStats()}
function loadResellerUsers(){const tbody=document.getElementById("resellerUsersTable");tbody.innerHTML="";sessionData.resellerUsers.forEach(u=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${u.id}</td><td>${sanitizeInput(u.username)}</td><td>${sanitizeInput(u.email)}</td><td>${sanitizeInput(u.status)}</td><td><button class="btn-action btn-edit" onclick="editResellerUser(${u.id})">Редактировать</button><button class="btn-action btn-delete" onclick="deleteResellerUser(${u.id})">Удалить</button></td>`;tbody.appendChild(tr)})}
function loadResellerProducts(){const tbody=document.getElementById("resellerProductsTable");tbody.innerHTML="";sessionData.resellerProducts.forEach(p=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${p.id}</td><td>${sanitizeInput(p.name)}</td><td>${sanitizeInput(p.type)}</td><td>₽${p.price}</td><td><button class="btn-action btn-edit" onclick="editResellerProduct(${p.id})">Редактировать</button><button class="btn-action btn-delete" onclick="deleteResellerProduct(${p.id})">Удалить</button></td>`;tbody.appendChild(tr)})}
function updateResellerStats(){document.getElementById("resellerUserCount").textContent=sessionData.resellerUsers.length;document.getElementById("resellerProductCount").textContent=sessionData.resellerProducts.length}
function addUser(){const username=sanitizeInput(document.getElementById("newUserUsername").value.trim());const email=sanitizeInput(document.getElementById("newUserEmail").value.trim());const password=document.getElementById("newUserPassword").value;if(!username||!email||!password){showNotification("Заполните все поля","error");return}const u={id:Date.now(),username,email,status:"Активен"};sessionData.resellerUsers.push(u);sessionData.logs.unshift({who:currentUser.username,what:`Добавил пользователя ${username}`,when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});loadResellerUsers();updateResellerStats();closeModal("addUserModal");document.getElementById("addUserForm").reset();showNotification("Пользователь добавлен","success")}
function addProduct(){const name=sanitizeInput(document.getElementById("newProductName").value.trim());const type=document.getElementById("newProductType").value;const price=parseInt(document.getElementById("newProductPrice").value);if(!name||!price){showNotification("Заполните все поля","error");return}const p={id:Date.now(),name,type,price};sessionData.resellerProducts.push(p);sessionData.logs.unshift({who:currentUser.username,what:`Добавил продукт ${name}`,when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});loadResellerProducts();updateResellerStats();closeModal("addProductModal");document.getElementById("addProductForm").reset();showNotification("Продукт добавлен","success")}
function editResellerUser(id){const u=sessionData.resellerUsers.find(x=>x.id===id);if(!u)return;document.getElementById("editUserId").value=u.id;document.getElementById("editUserUsername").value=u.username;document.getElementById("editUserEmail").value=u.email;openModal("editUserModal")}
function updateUser(){const id=parseInt(document.getElementById("editUserId").value);const username=sanitizeInput(document.getElementById("editUserUsername").value.trim());const email=sanitizeInput(document.getElementById("editUserEmail").value.trim());const u=sessionData.resellerUsers.find(x=>x.id===id);if(u){u.username=username;u.email=email;sessionData.logs.unshift({who:currentUser.username,what:`Обновил данные пользователя ${username}`,when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});loadResellerUsers();closeModal("editUserModal");showNotification("Пользователь обновлен","success")}}
function deleteResellerUser(id){if(!confirm("Вы уверены, что хотите удалить этого пользователя?"))return;const u=sessionData.resellerUsers.find(x=>x.id===id);sessionData.resellerUsers=sessionData.resellerUsers.filter(x=>x.id!==id);sessionData.logs.unshift({who:currentUser.username,what:`Удалил пользователя ${u?u.username:id}`,when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});loadResellerUsers();updateResellerStats();showNotification("Пользователь удален","success")}
function editResellerProduct(id){const p=sessionData.resellerProducts.find(x=>x.id===id);if(!p)return;document.getElementById("editProductId").value=p.id;document.getElementById("editProductName").value=p.name;document.getElementById("editProductType").value=p.type;document.getElementById("editProductPrice").value=p.price;openModal("editProductModal")}
function updateProduct(){const id=parseInt(document.getElementById("editProductId").value);const name=sanitizeInput(document.getElementById("editProductName").value.trim());const type=document.getElementById("editProductType").value;const price=parseInt(document.getElementById("editProductPrice").value);const p=sessionData.resellerProducts.find(x=>x.id===id);if(p){p.name=name;p.type=type;p.price=price;sessionData.logs.unshift({who:currentUser.username,what:`Обновил продукт ${name}`,when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});loadResellerProducts();closeModal("editProductModal");showNotification("Продукт обновлен","success")}}
function deleteResellerProduct(id){if(!confirm("Вы уверены, что хотите удалить этот продукт?"))return;const p=sessionData.resellerProducts.find(x=>x.id===id);sessionData.resellerProducts=sessionData.resellerProducts.filter(x=>x.id!==id);sessionData.logs.unshift({who:currentUser.username,what:`Удалил продукт ${p?p.name:id}`,when:new Date().toLocaleString("ru-RU",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})});loadResellerProducts();updateResellerStats();showNotification("Продукт удален","success")}
function loadAdminData(){loadAdminUsers();loadAdminResellers();loadAdminLogs();updateAdminStats()}
function loadAdminUsers(){const tbody=document.getElementById("adminUsersTable");tbody.innerHTML="";sessionData.users.forEach(u=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${u.id}</td><td>${sanitizeInput(u.username)}</td><td>${sanitizeInput(u.role)}</td><td>${sanitizeInput(u.email)}</td><td><span style="color: ${u.status==="Активен"?"#4CAF50":"#f44336"}">${sanitizeInput(u.status)}</span></td><td><button class="btn-action btn-edit" onclick="showNotification('Редактирование доступно для демо','info')">Просмотр</button></td>`;tbody.appendChild(tr)})}
function loadAdminResellers(){const tbody=document.getElementById("adminResellersTable");tbody.innerHTML="";const rs=sessionData.users.filter(u=>u.role==="Reseller");rs.forEach(r=>{const tr=document.createElement("tr");tr.innerHTML=`<td>${r.id}</td><td>${sanitizeInput(r.username)}</td><td>${sessionData.resellerUsers.length}</td><td>${sessionData.resellerProducts.length}</td><td><span style="color: #4CAF50">${sanitizeInput(r.status)}</span></td>`;tbody.appendChild(tr)})}
function loadAdminLogs(){const c=document.getElementById("adminLogsContainer");c.innerHTML="";sessionData.logs.forEach(l=>{const e=document.createElement("div");e.className="log-entry";e.innerHTML=`<div class="log-header"><span class="log-user">${sanitizeInput(l.who)}</span><span class="log-time">${sanitizeInput(l.when)}</span></div><div class="log-action">${sanitizeInput(l.what)}</div>`;c.appendChild(e)})}
function updateAdminStats(){document.getElementById("adminTotalUsers").textContent=sessionData.users.length;document.getElementById("adminTotalResellers").textContent=sessionData.users.filter(u=>u.role==="Reseller").length;document.getElementById("adminTotalLogs").textContent=sessionData.logs.length}
document.addEventListener("DOMContentLoaded",()=>{console.log("ZalypaSPB Dashboard initialized")});
